@{
    Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
    ViewData["Title"] = "Create Receipt";
    ViewData["PageHeader"] = "Create Receipt";
    ViewData["PageSubtitle"] = "Complete Service and Generate Receipt";
    ViewData["ActivePage"] = "MyAppointments";

    var appointment = ViewBag.Appointment as FYP___Vehicules_Service_and_Maintenance_Record_System.Models.Appointment;
    var parts = ViewBag.Parts as List<FYP___Vehicules_Service_and_Maintenance_Record_System.Models.Part>;
}

<div class="container-xxl py-5">
    <div class="container">
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fa fa-exclamation-triangle me-2"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="row g-5">
            <!-- Appointment Details -->
            <div class="col-lg-6 wow fadeInUp" data-wow-delay="0.1s">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-calendar me-2"></i>Appointment Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong><i class="fa fa-hashtag text-primary me-2"></i>Appointment ID:</strong>
                            <span class="ms-2">#@appointment.ID</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-user text-primary me-2"></i>Customer:</strong>
                            <span class="ms-2">@appointment.Car?.User?.FirstName @appointment.Car?.User?.LastName</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-car text-primary me-2"></i>Vehicle:</strong>
                            <span class="ms-2">@appointment.Car?.Year @appointment.Car?.Make @appointment.Car?.Model</span>
                            <br />
                            <small class="text-muted ms-4">Plate: @appointment.Car?.PlateNumber</small>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-tools text-primary me-2"></i>Service:</strong>
                            <span class="ms-2">@appointment.Service?.ServiceName</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-calendar text-primary me-2"></i>Date:</strong>
                            <span class="ms-2">@appointment.ScheduleAppointment.ToString("MMMM dd, yyyy hh:mm tt")</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-user-tie text-primary me-2"></i>Technician:</strong>
                            <span class="ms-2">@appointment.Employee?.User?.FirstName @appointment.Employee?.User?.LastName</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="fa fa-dollar-sign text-success me-2"></i>Service Fee:</strong>
                            <span class="ms-2 text-success fs-5">$@appointment.Employee?.FeeByService.ToString("F2")</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Form -->
            <div class="col-lg-6 wow fadeInUp" data-wow-delay="0.3s">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fa fa-file-invoice me-2"></i>Add Parts Used</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-action="CreateReceipt" asp-controller="Employee" id="receiptForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="appointmentId" value="@appointment.ID" />

                            <div class="alert alert-info">
                                <i class="fa fa-info-circle me-2"></i>
                                <strong>Instructions:</strong> Select the parts used during this service and specify quantities.
                            </div>

                            <div id="partsContainer">
                                @if (parts != null && parts.Any())
                                {
                                    <div class="mb-4">
                                        <h6 class="mb-3">Available Parts:</h6>
                                        @foreach (var part in parts)
                                        {
                                            <div class="card mb-2">
                                                <div class="card-body p-3">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input part-checkbox" 
                                                                       type="checkbox" 
                                                                       value="@part.ID" 
                                                                       id="part@(part.ID)"
                                                                       data-max="@part.Quantity"
                                                                       data-price="@part.Price">
                                                                <label class="form-check-label" for="part@(part.ID)">
                                                                    <strong>@part.PartName</strong>
                                                                    <br />
                                                                    <small class="text-muted">
                                                                        $@part.Price.ToString("F2") each | Available: @part.Quantity
                                                                    </small>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label class="form-label">Quantity:</label>
                                                            <input type="number" 
                                                                   class="form-control quantity-input" 
                                                                   name="quantities" 
                                                                   min="0" 
                                                                   max="@part.Quantity" 
                                                                   value="0" 
                                                                   disabled
                                                                   data-part-id="@part.ID">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h5 class="mb-3">Receipt Summary:</h5>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Service Fee:</span>
                                                <strong>$@appointment.Employee?.FeeByService.ToString("F2")</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Parts Cost:</span>
                                                <strong id="partsCost">$0.00</strong>
                                            </div>
                                            <hr />
                                            <div class="d-flex justify-content-between">
                                                <h5>Total:</h5>
                                                <h5 class="text-success" id="totalCost">$@appointment.Employee?.FeeByService.ToString("F2")</h5>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 mt-4">
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fa fa-check me-2"></i>Complete Service & Create Receipt
                                        </button>
                                        <a href="@Url.Action("MyAppointments", "Employee")" class="btn btn-secondary btn-lg">
                                            <i class="fa fa-arrow-left me-2"></i>Cancel
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        <i class="fa fa-exclamation-triangle me-2"></i>
                                        No parts available in inventory. You can still create a receipt with service fee only.
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fa fa-check me-2"></i>Create Receipt (Service Only)
                                        </button>
                                        <a href="@Url.Action("MyAppointments", "Employee")" class="btn btn-secondary btn-lg">
                                            <i class="fa fa-arrow-left me-2"></i>Cancel
                                        </a>
                                    </div>
                                }
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const serviceFee = @appointment.Employee?.FeeByService ?? 0;

            function calculateTotal() {
                let partsCost = 0;
                
                $('.part-checkbox:checked').each(function() {
                    const partId = $(this).val();
                    const price = parseFloat($(this).data('price'));
                    const quantity = parseInt($(`input[data-part-id="${partId}"]`).val()) || 0;
                    partsCost += price * quantity;
                });

                const total = serviceFee + partsCost;
                
                $('#partsCost').text('$' + partsCost.toFixed(2));
                $('#totalCost').text('$' + total.toFixed(2));
            }

            $('.part-checkbox').change(function() {
                const partId = $(this).val();
                const quantityInput = $(`input[data-part-id="${partId}"]`);
                
                if ($(this).is(':checked')) {
                    quantityInput.prop('disabled', false);
                    quantityInput.val(1);
                    // Add hidden input for partId
                    if ($(`input[name="partIds"][value="${partId}"]`).length === 0) {
                        $(this).parent().append(`<input type="hidden" name="partIds" value="${partId}">`);
                    }
                } else {
                    quantityInput.prop('disabled', true);
                    quantityInput.val(0);
                    // Remove hidden input
                    $(`input[name="partIds"][value="${partId}"]`).remove();
                }
                
                calculateTotal();
            });

            $('.quantity-input').on('input', function() {
                calculateTotal();
            });

            $('#receiptForm').submit(function(e) {
                // Remove quantities for unchecked parts
                $('.quantity-input:disabled').val(0);
                
                let hasSelectedParts = $('.part-checkbox:checked').length > 0;
                if (!hasSelectedParts) {
                    return confirm('No parts selected. Create receipt with service fee only?');
                }
                
                return confirm('Complete this service and create receipt? This will mark the appointment as completed.');
            });
        });
    </script>
}
